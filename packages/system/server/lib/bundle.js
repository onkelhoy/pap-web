"use strict";var q=Object.create;var O=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var ne=Object.getOwnPropertyNames;var te=Object.getPrototypeOf,oe=Object.prototype.hasOwnProperty;var se=(n,e)=>{for(var t in e)O(n,t,{get:e[t],enumerable:!0})},M=(n,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of ne(e))!oe.call(n,r)&&r!==t&&O(n,r,{get:()=>e[r],enumerable:!(o=ee(e,r))||o.enumerable});return n};var p=(n,e,t)=>(t=n!=null?q(te(n)):{},M(e||!n||!n.__esModule?O(t,"default",{value:n,enumerable:!0}):t,n)),re=n=>M(O({},"__esModule",{value:!0}),n);var Ee={};se(Ee,{close:()=>A,server:()=>c,start:()=>S});module.exports=re(Ee);var Q=p(require("node:http"));var C=require("node:crypto"),a=new Map;function V(n,e,t){let o=n.headers["sec-websocket-key"],i=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${(0,C.createHash)("sha1").update(o+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11").digest("base64")}`];e.write(i.join(`\r
`)+`\r
\r
`);let s=(0,C.randomUUID)();a.set(s,e),["verbose","debug"].includes(process.env.LOGLEVEL||"")&&console.log("\x1B[31m","client connected","\x1B[0m"),e.on("error",ie.bind(e,s)),e.on("data",ce.bind(e,s)),e.on("end",le.bind(e,s))}function ie(n,e){"code"in e&&e.code==="ECONNRESET"?(["verbose","debug"].includes(process.env.LOGLEVEL||"")&&console.log("\x1B[31m","client disconnected","\x1B[0m"),a.delete(n)):process.env.LOGLEVEL!=="none"&&console.log("socket-error",n,e)}function ce(n,e){let t=e.toString();["debug"].includes(process.env.LOGLEVEL||"")&&console.log("\x1B[34m","Received: ",t,"\x1B[0m"),this.write(w(t))}function le(n){["verbose","debug"].includes(process.env.LOGLEVEL||"")&&console.log("\x1B[31m","client disconnected","\x1B[0m"),a.delete(n)}function H(n,e){if(a.size===0){["debug"].includes(process.env.LOGLEVEL||"")&&console.log("No clients connected to send update!");return}let t=w({action:"update",filename:n,content:e});a.forEach(o=>{o?o.write(t):["debug"].includes(process.env.LOGLEVEL||"")&&console.log("socket-error: [update] could not find client")})}function k(n,e){a.size===0&&["debug"].includes(process.env.LOGLEVEL||"")&&console.log("No clients connected to send error!");let t=w({action:"error",filename:n,error:e});a.forEach(o=>{o?o.write(t):["debug"].includes(process.env.LOGLEVEL||"")&&console.log("socket-error: [error] could not find client")})}function w(n){let e=JSON.stringify(n),t=Buffer.byteLength(e),o=t<126?0:2,r=o===0?t:126,i=Buffer.alloc(2+o+t);return i[0]=129,i[1]=r,o>0&&i.writeUInt16BE(t,2),i.write(e,2+o),i}var _=p(require("node:fs")),m=p(require("node:path")),z=require("node:url");var $=p(require("node:fs")),d=p(require("node:path")),y=p(require("esbuild"));var pe=d.default.join(process.env.LOCATION,".temp"),ae={name:"rebuild",setup(n){n.onEnd(e=>{try{let t=n.initialOptions.entryPoints[0];if(h[t].builds++,h[t].builds>1){let o=t.split("/").pop();if(e.errors.length>0){k(o,e.errors);return}let r=d.default.join(pe,o),i=$.default.readFileSync(r,"utf-8");H(o,i)}}catch(t){["verbose","debug"].includes(process.env.LOGLEVEL||"")&&console.log(t),console.log("something went wrong")}})}},F=d.default.join(process.env.LOCATION,".temp");function B(n){let e=process.env.LOCATION;return e.endsWith("/")||(e+="/"),n.replace(e,"")}var h={};async function U(n){if(!h[n]){["verbose","debug"].includes(process.env.LOGLEVEL||"")&&console.log("[esbuild - watch]",n);let e=d.default.join(F,B(n));await I(n,e);let t=await y.context({entryPoints:[n],bundle:!0,outfile:e,plugins:[ae]});h[n]={ctx:t,builds:0},await t.watch()}}async function I(n,e=null){e===null&&(["verbose","debug"].includes(process.env.LOGLEVEL||"")&&console.log("[esbuild - build]",n),e=d.default.join(F,B(n))),await y.build({entryPoints:[n],bundle:!0,outfile:e})}function W(){["verbose","debug"].includes(process.env.LOGLEVEL||"")&&console.log("\x1B[32m- [esbuild] disposing watcher-contexts\x1B[0m"),Object.values(h).forEach(n=>n.ctx.dispose())}var N=p(require("node:fs")),j=p(require("node:path")),ue=JSON.parse(N.default.readFileSync(j.default.resolve(process.env.ROOTDIR,"package-lock.json")).toString()),Oe=JSON.parse(N.default.readFileSync(j.default.resolve(process.env.PACKAGE,"package.json")).toString()),D={},Ce=ue.name.split("/")[0];var b=p(require("node:path")),g=p(require("node:fs")),f=require("node-html-parser"),E={common:{file:null},live:{file:null,process:n=>n.replace("PLACEHOLDER_PORT",process.env.PORT)},notfound:{file:null,process:n=>n.replace("PLACEHOLDER_NAME",process.env.NAME||"@papit/server")},directory:{file:null},wrapper:{file:null}};function J(n,e){let t=n.url;t.endsWith(".html")||(t.endsWith("/")||(t+="/"),t+="index.html");let o=null;try{let r=g.default.readFileSync(b.default.join(process.env.LOCATION,t),"utf-8");o=R((0,f.parse)(r))}catch(r){let i=b.default.join(process.env.LOCATION,n.url);if(g.default.existsSync(i)){o=R(T("directory"));let s=o.querySelector("#list");s&&(s.innerHTML="");let x=[],G=[];g.default.readdirSync(i,{withFileTypes:!0}).forEach(l=>{l.name!==".temp"&&(l.isDirectory()?G.push(l.name):x.push(l.name))}),n.url===""||n.url==="/"||s==null||s.appendChild((0,f.parse)(`<li><span>\u{1F5C2}\uFE0F</span><a href="${b.default.dirname(n.url)}">..</a></li>`)),G.forEach(l=>{s==null||s.appendChild((0,f.parse)(`<li><span>\u{1F5C2}\uFE0F</span><a href="/${l}">${l}/</a></li>`))}),x.forEach(l=>{s==null||s.appendChild((0,f.parse)(`<li><span>\u{1F4C4}</span><a href="/${l}">${l}</a></li>`))})}else o=R(T("notfound"))}if(o!==null){let r=o.toString();e.statusCode=200,e.setHeader("Content-Type","text/html"),e.end(r)}else e.statusCode=500,e.setHeader("Content-Type","application/json"),e.end(JSON.stringify({error:"something went wrong getting HTML file"})),process.env.LOGLEVEL!=="none"&&console.log("\x1B[31m[error] something went wrong on server processing document\x1B[0m")}function T(n){let e=process.env[n.toUpperCase()];if((typeof e!="string"||!g.default.existsSync(e))&&(e=b.default.join(process.env.SCRIPTDIR,`template/${n}.html`)),!E[n].file){let t=g.default.readFileSync(e,"utf-8");E[n].process&&(t=E[n].process(t)),E[n].file=(0,f.parse)(t)}return E[n].file}function R(n){var e,t;return process.env.LIVE&&((e=n.querySelector("head"))==null||e.appendChild(T("live"))),(t=n.querySelector("head"))==null||t.appendChild(T("common")),n}var de=(process.env.ASSET_DIRS||"").split(" ");function X(n,e){if(n.method!=="GET"){["verbose","debug"].includes(process.env.LOGLEVEL||"")&&console.log("\x1B[31mno get request\x1B[0m"),e.statusCode=500,e.setHeader("Content-Type","application/json"),e.end(JSON.stringify({error:`only accept get requests: ${n.method}`,code:"no-get"}));return}if(!n.url){["verbose","debug"].includes(process.env.LOGLEVEL||"")&&console.log("\x1B[31mno url provided\x1B[0m"),e.statusCode=500,e.setHeader("Content-Type","application/json"),e.end(JSON.stringify({error:"no url provided",code:"no-url"}));return}if(["verbose","debug"].includes(process.env.LOGLEVEL||"")&&console.log("\x1B[36mincomming request\x1B[0m",n.url),/^(\/([^\/]+\/)*([^\/\.]+|[^\/]+\.html)?)?$/.test(n.url)){J(n,e);return}if(n.url.startsWith("/asset-info")){fe(n,e);return}ge(n,e)}function fe(n,e){e.statusCode=200,e.setHeader("Content-Type","text/html"),e.end("<h1>hello asset</h1>")}async function ge(n,e){let t=Y(n);if(t===null)e.statusCode=404,e.setHeader("Content-Type","application/json"),e.end(JSON.stringify({error:`file not found: "${n.url}"`}));else{if(e.statusCode=200,e.setHeader("Content-Type",he(t.url)),t.url.endsWith(".js")&&!t.url.includes(".temp")&&(process.env.LIVE?await U(t.url):await I(t.url),t=Y(n),t===null)){e.statusCode=500,e.setHeader("Content-Type","application/json"),e.end(JSON.stringify({error:`esbuild went wrong: "${n.url}"`}));return}e.end(t.data)}}function me(n){let e="";if(n.headers.referer){let o=new z.URL(n.headers.referer).pathname;/\w*\.\w+$/.test(o)&&(o=o.substring(0,o.lastIndexOf("/"))),e=o}return e}function Y(n){let e=n.url,t=null,o=me(n),r=o;r.endsWith("/")||(r+="/");let i=e;if(e.startsWith(r)&&(i=e.split(r)[1]),t=L(m.default.join(process.env.LOCATION,".temp",o,i)),t!==null||(t=L(m.default.join(process.env.LOCATION,o,i)),t!==null))return t;for(let s of["asset","assets","public"])if(t=L(m.default.join(process.env.LOCATION,o,s,i)),t!==null)return t;for(let s of de)if(t=L(m.default.join(s,e)),t!==null)return t;for(let s in D){let x=D[s];if(t=L(m.default.join(x.path,"asset",e)),t!==null)return t}return null}function L(n){try{return{data:_.default.readFileSync(n),url:n}}catch(e){return null}}var K={js:"text/javascript",css:"text/css",csv:"text/csv",pdf:"application/pdf",json:"application/json",png:"image/png",jpeg:"image/jpeg",jpg:"image/jpeg",gif:"image/gif",svg:"image/svg+xml",mpeg:"video/mpeg",mp4:"video/mp4",quicktime:"video/quicktime",webm:"video/webm"};function he(n){let e=n.match(/\.(.+)$/);if(e){let t=e[1].toLowerCase();if(K[t])return K[t]}return"text/plain"}var v=Number(process.env.PORT||3e3),u=0,c=null;function S(){c=Q.default.createServer(),c.listen(v+u,()=>{process.env.PORT=v+u+"",process.env.LOGLEVEL!=="none"&&console.log("\x1B[33m",`server:\x1B[36m${v+u}\x1B[33m  - running`,"\x1B[0m")}),c.on("request",X),c.on("error",n=>{"code"in n&&n.code==="EADDRINUSE"&&(u++,u<10?(c&&c.close(),S()):process.env.LOGLEVEL!=="none"&&console.log(`[\x1B[31merror\x1B[0m] port spaces between [${process.env.PORT||3e3}, ${v+u}] are all taken, please free up some ports`))}),c.on("upgrade",V)}function A(){c==null||c.close(),process.env.LOGLEVEL!=="none"&&console.log("\x1B[33m",`server:\x1B[36m${v+u}\x1B[33m - shutdown`,"\x1B[0m")}process.on("EXIT",P);process.on("SIGINT",P);process.on("SIGTERM",P);var Z=0;function P(){Z>0||(Z++,console.log(""),W(),A(),process.exit(0))}process.env.AUTOSTART&&S();0&&(module.exports={close,server,start});
